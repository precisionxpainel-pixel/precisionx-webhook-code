import express from "express";
import cors from "cors";
import admin from "firebase-admin";
import nodemailer from "nodemailer";

// Inicializa o Express
const app = express();
app.use(cors());
app.use(express.json());

// ğŸ” Inicializa o Firebase Admin
if (!admin.apps.length) {
  try {
    const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON);
    admin.initializeApp({
      credential: admin.credential.cert(serviceAccount),
    });
    console.log("ğŸ”¥ Firebase inicializado com sucesso!");
  } catch (error) {
    console.error("Erro ao inicializar Firebase:", error);
  }
}

// ğŸ”” Rota principal do webhook
app.post("/api/cakto-webhook", async (req, res) => {
  try {
    const { event, data, secret } = req.body;

    // ğŸ”’ VerificaÃ§Ã£o do segredo
    if (secret !== process.env.ALLOWED_SECRET) {
      return res.status(401).json({ ok: false, message: "Unauthorized" });
    }

    // ğŸ›’ Se o evento for uma compra aprovada:
    if (event === "purchase_approved") {
      const email = data?.customer?.email;
      const productName = data?.product?.name;

      // âœ… Cria ou atualiza usuÃ¡rio no Firebase
      let userRecord;
      try {
        userRecord = await admin.auth().getUserByEmail(email);
      } catch (err) {
        userRecord = await admin.auth().createUser({ email, emailVerified: true });
      }

      // âœ‰ï¸ Envia e-mail de boas-vindas (opcional)
      const transporter = nodemailer.createTransport({
        service: "gmail",
        auth: {
          user: process.env.SMTP_USER,
          pass: process.env.SMTP_PASS,
        },
      });

      const mailOptions = {
        from: `"Lua Lash Academy" <${process.env.SMTP_USER}>`,
        to: email,
        subject: "Acesso liberado â€” Lua Lash Academy ğŸ’–",
        html: `
          <h2>âœ¨ OlÃ¡, ${email.split("@")[0]}!</h2>
          <p>Sua compra do produto <b>${productName}</b> foi aprovada com sucesso!</p>
          <p>Agora vocÃª jÃ¡ tem acesso Ã  Ã¡rea exclusiva.</p>
          <p>Beijos da Lua ğŸ’•</p>
        `,
      };

      await transporter.sendMail(mailOptions);

      console.log("âœ… E-mail enviado e usuÃ¡rio processado:", email);
      return res.status(200).json({
        ok: true,
        message: "UsuÃ¡rio processado e e-mail enviado.",
        email,
        productName,
      });
    }

    // Caso o evento nÃ£o seja "purchase_approved"
    return res.status(200).json({ ok: true, message: "Evento ignorado." });
  } catch (error) {
    console.error("ğŸ”¥ ERRO NO PROCESSAMENTO:", error);
    return res.status(500).json({ ok: false, error: error.message });
  }
});

// ğŸ” Resposta para GET (teste manual pelo navegador)
app.get("/api/cakto-webhook", (req, res) => {
  return res.status(200).json({
    ok: true,
    message: "Webhook ativo e pronto para receber POST da Cakto ğŸš€",
  });
});

// Exporta o app (necessÃ¡rio para rodar na Vercel)
export default app;
